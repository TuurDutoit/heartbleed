module.exports = function when(emitter, event, test) {
    if(typeof event !== 'string') {
        test = event;
        event = 'data';
    }

    return new Promise(function(resolve, reject) {
        function listener(data) {
            if (test == null || test(data)) {
                off();
                resolve(data);
            }
        }
        
        function error(err) {
            off();
            reject(err);
        }
        
        function off() {
            emitter.off(event, listener);
            emitter.off('error', error);
        }
        
        emitter.on(event, listener);
        emitter.on('error', error);
    });
}